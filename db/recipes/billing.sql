truncate table billing_deposit;
insert into billing_deposit (id_study,id_item,id_uuid,id_site,freezer,subdiv1,subdiv2,subdiv3,destination,date_deposit,date_moved)  (select items.id_study,items.id,items.id_uuid,locations.id_site,freezer,subdiv1,subdiv2,subdiv3,locations.destination,locations.timestamp,locations.date_moved from items left join locations on items.id = locations.id_item where items.type = 'box' and locations.date_moved is null and (id_site in (1,2) or id_study in ('CGI')));
delete from billing_deposit where id_study != 'CRIC' or freezer is null or id_study is null;
update billing_deposit left join (select child.id_item,samplecount,boxcount from (select id_item,abs(divX*divY) samplecount from billing_deposit left join items on items.id = billing_deposit.id_item) child,(select billing_deposit.id_item,abs(divX*divY) boxcount from billing_deposit left join locations on billing_deposit.id_item = locations.id_item left join items on items.id = locations.id_container) parent where parent.id_item = child.id_item) dimensions on billing_deposit.id_item = dimensions.id_item set billing_deposit.boxsize = if(boxcount=6,5,3) where samplecount!=81;
update billing_deposit left join studies on studies.id_study = billing_deposit.id_study set billing_deposit.pennkey = studies.pi;
update billing_deposit left join (select freezer,subdiv1,name_owner from items left join locations on items.id = locations.id_item where type = 'shelf') owners on billing_deposit.freezer = owners.freezer and billing_deposit.subdiv1 = owners.subdiv1 set owner = name_owner where name_owner is not null;
#select count(*) quant,id_study,freezer,boxsize from billing_deposit group by freezer,boxsize;
